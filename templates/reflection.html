{% extends 'base.html' %}
{% block content %}
<div class="reflect-dashboard">

  <!-- Sidebar: Mood Stats and Quick Actions -->
  <aside class="reflect-sidebar">
    <div class="reflect-mini-card mood-breakdown">
      <h4>Mood Breakdown</h4>
      <ul>
        {% for mood, count in mood_counts.items() %}
          <li>
            <span class="mood-label mood-{{ mood|lower }}">{{ mood }}</span> â€“ {{ count }}
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="reflect-mini-card">
      <h4>Streak</h4>
      <p>
        <span class="streak-count">{{ streak }}</span> day streak!
      </p>
    </div>
    <div class="reflect-mini-card">
      <h4>Reflection Tips</h4>
      <ul>
        <li>Reflect at the same time daily for best results.</li>
        <li>Try to write at least one sentenceâ€”even on tough days!</li>
        <li>Look back at your progress every week.</li>
      </ul>
    </div>
  </aside>

  <!-- Main Content: Reflection Form, Prompts, and Recent -->
  <section class="reflection-content">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="flash-{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    {% if error %}
      <div class="form-error">{{ error }}</div>
    {% endif %}
    <div class="reflection-card">
      <h2 class="card-title">Reflect</h2>
      <button type="button" id="openTipsModal" class="btn-cyan modal-trigger">Show Reflection Tips</button>

      <!-- Modal -->
      <div id="tipsModal" class="modal">
        <div class="modal-content">
          <button id="closeTipsModal" class="modal-close">&times;</button>
          <h4>Reflection Tips</h4>
          <ul>
            <li>Reflect at the same time daily for best results.</li>
            <li>Try to write at least one sentenceâ€”even on tough days!</li>
            <li>Look back at your progress every week.</li>
            <li>Focus on how you feel, not just what happened.</li>
          </ul>
        </div>
      </div>

      {% if session.get('name') %}
        <p class="subtle">Welcome back, <strong>{{ session.get('name') }}</strong>! Take a moment to log your thoughts.</p>
      {% else %}
        <p class="subtle">How are you feeling after your session?</p>
      {% endif %}
      <form method="POST" autocomplete="off" aria-label="Reflection Form" class="reflection-form">
        <div class="row two-cols">
          <div>
            <label for="mood">Mood:</label>
            <select name="mood" required>
              <option value="">--Select--</option>
              <option value="Happy">ğŸ˜„ Happy</option>
              <option value="Neutral">ğŸ˜ Neutral</option>
              <option value="Frustrated">ğŸ˜– Frustrated</option>
              <option value="Inspired">ğŸŒŸ Inspired</option>
              <option value="Tired">ğŸ˜´ Tired</option>
            </select>
          </div>
          <div>
            <label for="tag">Tag:</label>
            <select name="tag">
              <option value="general">General</option>
              <option value="study">Study</option>
              <option value="health">Health</option>
              <option value="fun">Fun</option>
              <option value="life">Life</option>
            </select>
          </div>
        </div>
        <label for="notes">Reflection:</label>
        <textarea name="notes" rows="4" placeholder="What did you learn? What stood out?" required></textarea>
        <button type="submit" class="btn-green">Submit Reflection</button>
      </form>
      <div class="reflection-tips inspiration-list">
        <strong>Need Inspiration?</strong>
        <ul id="prompt-list">
          <li>Whatâ€™s something you accomplished today?</li>
          <li>What challenged you the most?</li>
          <li>Whatâ€™s one thing youâ€™re grateful for right now?</li>
          <li>Describe a moment that made you smile recently.</li>
        </ul>
        <small class="subtle tip-note">Tip: Entries stay private and help you see your growth!</small>
      </div>
      <p class="quote-socrates">â€œThe unexamined life is not worth living.â€ â€” Socrates</p>
    </div>
    {% if latest_reflection %}
    <div class="last-reflection-card highlight">
      <h4>Last Reflection</h4>
      <p><em>{{ latest_reflection.timestamp }}</em> â€“ <strong>{{ latest_reflection.mood }}</strong> [{{ latest_reflection.tag }}]</p>
      <blockquote>â€œ{{ latest_reflection.notes[:100] }}{% if latest_reflection.notes|length > 100 %}...{% endif %}â€</blockquote>
    </div>
    {% endif %}
    {% if reflections|length > 3 %}
    <div class="recent-reflections-list">
      <h4>Past Reflections</h4>
      <ul>
        {% for entry in reflections[-4:-1] %}
          <li>
            <span class="mood-label mood-{{ entry.mood|lower }}">{{ entry.mood }}</span>
            <em>({{ entry.timestamp }})</em> - {{ entry.notes[:65] }}{% if entry.notes|length > 65 %}...{% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </section>
</div>
{% endblock %}
